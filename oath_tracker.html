<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Oathsworn Tracker - Space Marines</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #111827; color: #E5E7EB; }
        .grimdark-title { font-weight: 900; text-transform: uppercase; letter-spacing: 0.1em; color: #F9FAFB; text-shadow: 0 0 10px rgba(220, 38, 38, 0.5); }
        .card { background-color: #1F2937; border: 1px solid #374151; border-radius: 0.5rem; padding: 1.5rem; }
        .input-dark { background-color: #111827; border: 1px solid #4B5563; color: white; padding: 0.5rem; border-radius: 0.25rem; width: 100%; }
        /* Animaci√≥n de carga */
        .loader { border-top-color: #3B82F6; -webkit-animation: spinner 1.5s linear infinite; animation: spinner 1.5s linear infinite; }
        @-webkit-keyframes spinner { 0% { -webkit-transform: rotate(0deg); } 100% { -webkit-transform: rotate(360deg); } }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="antialiased p-6 bg-gray-900">

    <!-- URL DE TU NUEVO GOOGLE APPS SCRIPT (OATHSWORN) -->
    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbxOGshWBF3KviGBkurNrjhQvku6Ahm8Q4ebX8LHZkNczGZkibe9LqVTEnKwxsj3W-kE/exec";
    </script>

    <div class="max-w-4xl mx-auto">
        <!-- Bot√≥n de Navegaci√≥n Superior -->
        <div class="mb-6">
            <a href="ob_sm.html" class="inline-flex items-center text-sm text-blue-400 hover:text-blue-300 font-bold border border-blue-900 hover:border-blue-400 px-4 py-2 rounded transition-colors duration-200">
                <span class="mr-2">‚Üê</span> Volver al Orden de Batalla (Raven Guard)
            </a>
        </div>

        <header class="mb-8 text-center">
            <h1 class="grimdark-title text-3xl md:text-5xl mb-4">üõ°Ô∏è Oathsworn Campaign Tracker</h1>
        </header>

        <!-- LOADING STATE -->
        <div id="loading" class="flex flex-col items-center justify-center py-12">
            <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12 mb-4"></div>
            <p class="text-xl text-gray-400">Conectando con los archivos del Cap√≠tulo...</p>
        </div>

        <!-- PANTALLA 1: SELECCI√ìN DE JURAMENTO (Inicialmente oculta) -->
        <div id="setup-screen" class="hidden">
            <div class="card border-blue-900 max-w-2xl mx-auto text-center">
                <h2 class="text-2xl font-bold text-white mb-6">Selecciona tu Juramento</h2>
                <p class="text-gray-400 mb-8">No se ha detectado ninguna campa√±a activa. Debes jurar un nuevo Oathsworn antes de comenzar la batalla.</p>
                
                <div class="mb-8">
                    <label class="block text-left text-sm font-bold text-blue-400 mb-2">Juramentos Disponibles:</label>
                    <select id="campaign-selector" class="input-dark text-lg py-3">
                        <option value="">-- Seleccionar Juramento --</option>
                        <!-- Las opciones se llenar√°n din√°micamente -->
                    </select>
                </div>

                <button onclick="startCampaign()" class="w-full py-4 bg-blue-600 hover:bg-blue-500 text-white font-bold uppercase rounded transition duration-200">
                    Jurar y Comenzar Campa√±a
                </button>
            </div>
        </div>

        <!-- PANTALLA 2: TRACKER ACTIVO (Inicialmente oculta) -->
        <div id="tracker-screen" class="hidden">
            
            <!-- Cabecera de Campa√±a Activa -->
            <div class="flex flex-col md:flex-row justify-between items-center mb-8 bg-gray-800 p-4 rounded-lg border border-blue-900">
                <div>
                    <span class="text-gray-500 text-sm uppercase font-bold">Juramento Activo:</span>
                    <h2 id="active-campaign-name" class="text-2xl md:text-3xl font-bold text-blue-400 leading-none mt-1">Cargando...</h2>
                </div>
                <button onclick="resetCampaign()" class="mt-4 md:mt-0 px-4 py-2 bg-red-900/50 hover:bg-red-700 text-red-300 text-sm font-bold uppercase rounded border border-red-800 transition">
                    ‚ö†Ô∏è Abandonar Juramento (Reset)
                </button>
            </div>

            <!-- Contenedor de Tarjetas de Batalla -->
            <div id="battles-container" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Las tarjetas se generar√°n aqu√≠ -->
            </div>
        </div>

    </div>

    <script>
        // Variables globales para almacenar los datos cargados
        let loadedData = null;

        // --- FUNCI√ìN PRINCIPAL DE CARGA ---
        async function loadTracker() {
            showLoading(true);
            try {
                const response = await fetch(API_URL);
                loadedData = await response.json();
                renderApp();
            } catch (error) {
                alert("Error cr√≠tico cargando datos: " + error.message);
            } finally {
                showLoading(false);
            }
        }

        // --- RENDERIZADO DE LA APP ---
        function renderApp() {
            const activeName = loadedData.activeCampaign.name;

            if (!activeName) {
                // MODO SETUP: No hay campa√±a activa
                document.getElementById('tracker-screen').classList.add('hidden');
                document.getElementById('setup-screen').classList.remove('hidden');
                populateCampaignSelector();
            } else {
                // MODO TRACKER: Hay campa√±a activa
                document.getElementById('setup-screen').classList.add('hidden');
                document.getElementById('tracker-screen').classList.remove('hidden');
                
                document.getElementById('active-campaign-name').textContent = activeName;
                renderBattles();
            }
        }

        // --- FUNCIONES DE MODO SETUP ---
        function populateCampaignSelector() {
            const selector = document.getElementById('campaign-selector');
            selector.innerHTML = '<option value="">-- Seleccionar Juramento --</option>';
            loadedData.availableCampaigns.forEach(camp => {
                selector.innerHTML += `<option value="${camp.name}">${camp.name}</option>`;
            });
        }

        async function startCampaign() {
            const selectedCampaign = document.getElementById('campaign-selector').value;
            if (!selectedCampaign) {
                alert("Debes seleccionar un Juramento.");
                return;
            }

            if (!confirm(`¬øJuras solemnemente cumplir con "${selectedCampaign}"?`)) return;

            await sendApiRequest({ action: 'START', campaignName: selectedCampaign });
        }

        // --- FUNCIONES DE MODO TRACKER ---
        function renderBattles() {
            const container = document.getElementById('battles-container');
            container.innerHTML = '';
            const campaign = loadedData.activeCampaign;

            campaign.battles.forEach(battle => {
                // Generar opciones de Agenda para esta campa√±a espec√≠fica
                let agendaOptions = `<option value="">Seleccionar Agenda</option>`;
                campaign.agendas.forEach(agenda => {
                    const selected = (agenda === battle.agenda) ? 'selected' : '';
                    agendaOptions += `<option value="${agenda}" ${selected}>${agenda}</option>`;
                });

                container.innerHTML += `
                    <div class="card border-l-4 ${battle.points ? 'border-green-500' : 'border-gray-600'}">
                        <h3 class="text-xl font-bold mb-4 text-white flex justify-between">
                            <span>‚öîÔ∏è Batalla ${battle.id}</span>
                            ${battle.points ? '<span class="text-green-500 text-sm">Completada</span>' : ''}
                        </h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-xs uppercase text-gray-500 mb-1 font-bold">Agenda Jurada</label>
                                <select id="agenda-${battle.id}" class="input-dark border-blue-900/50 focus:border-blue-500 transition">
                                    ${agendaOptions}
                                </select>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-xs uppercase text-gray-500 mb-1 font-bold">Puntos Jugados</label>
                                    <input type="number" id="points-${battle.id}" value="${battle.points}" class="input-dark border-blue-900/50 focus:border-blue-500 text-center font-bold text-lg" min="0">
                                </div>
                                <div>
                                    <label class="block text-xs uppercase text-gray-500 mb-1 font-bold">Honour</label>
                                    <input type="number" id="honour-${battle.id}" value="${battle.honour}" class="input-dark border-blue-900/50 focus:border-blue-500 text-center font-bold text-lg" min="0">
                                </div>
                            </div>
                            <button onclick="saveBattle(${battle.id}, this)" class="w-full py-3 mt-2 bg-blue-900 hover:bg-blue-700 text-blue-100 font-bold uppercase text-sm rounded transition duration-200">
                                Guardar Resultado
                            </button>
                        </div>
                    </div>
                `;
            });
        }

        async function saveBattle(battleId, btnElement) {
            const originalText = btnElement.textContent;
            btnElement.textContent = "Guardando...";
            btnElement.disabled = true;

            const payload = {
                action: 'SAVE_BATTLE',
                battleId: battleId,
                agenda: document.getElementById(`agenda-${battleId}`).value,
                points: document.getElementById(`points-${battleId}`).value,
                honour: document.getElementById(`honour-${battleId}`).value
            };

            await sendApiRequest(payload, false); // False = no recargar toda la app, solo confirmar
            btnElement.textContent = "¬°Guardado!";
            setTimeout(() => {
                btnElement.textContent = originalText;
                btnElement.disabled = false;
            }, 2000);
        }

        async function resetCampaign() {
            if (confirm("¬øEST√ÅS SEGURO? Esto borrar√° TODO el progreso de la campa√±a actual. Esta acci√≥n no se puede deshacer.")) {
                 await sendApiRequest({ action: 'RESET' });
            }
        }

        // --- UTILIDADES ---
        async function sendApiRequest(payload, reload = true) {
            showLoading(true);
            try {
                await fetch(API_URL, {
                    method: 'POST',
                    mode: 'cors',
                    body: JSON.stringify(payload)
                });
                if (reload) {
                    await loadTracker(); // Recargar estado completo
                } else {
                    showLoading(false); // Solo ocultar loading si no recargamos
                }
            } catch (error) {
                alert("Error de conexi√≥n: " + error.message);
                showLoading(false);
            }
        }

        function showLoading(isLoading) {
            const loading = document.getElementById('loading');
            const setup = document.getElementById('setup-screen');
            const tracker = document.getElementById('tracker-screen');
            
            if (isLoading) {
                loading.classList.remove('hidden');
                setup.classList.add('hidden');
                tracker.classList.add('hidden');
            } else {
                loading.classList.add('hidden');
                // Las funciones renderApp() se encargar√°n de mostrar la pantalla correcta
            }
        }

        // INICIO
        loadTracker();
    </script>
</body>
</html>